#!/bin/bash
source /home/core/.profile
#ETH0=`/home/core/docker/shell/local_area_ip`

ETH0=$ETCD2_IP

if [ "$ETH0" = "" ]
then
  ETH0="127.0.0.1"
fi

etcdFileName=/etc/systemd/system/etcd.service
etcd2FileName=/etc/systemd/system/etcd2.service
sudo rm -rf $etcd2FileName
sudo rm -rf /etc/systemd/system/multi-user.target.wants/etcd2.service

if [ ! $DC_SERVER ]
then
    exit 0
fi

sudo touch $etcd2FileName
sudo chmod -R 777 $etcd2FileName

#sudo rm -rf /var/lib/etcd2/member

cat > $etcd2FileName << EOF
[Unit]
Description=etcd2
Conflicts=etcd.service

[Service]
User=etcd
Type=notify
ExecStart=/usr/bin/etcd2 --name `hostname` \
    --data-dir /var/lib/etcd2 \
    --listen-client-urls http://$ETH0:2379 \
    --advertise-client-urls http://$ETH0:2379 \
    --listen-peer-urls http://$ETH0:2380 \
    --initial-advertise-peer-urls http://$ETH0:2380 \
    --initial-cluster $DC_SERVER \
    --initial-cluster-token $DC_TOKEN \
    --initial-cluster-state new
Restart=always
RestartSec=10s
#LimitNOFILE=40000
TimeoutStartSec=0

[Install]
WantedBy=multi-user.target
EOF

sudo cp -rfp $etcd2FileName $etcdFileName

waitService etcd2
